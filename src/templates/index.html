<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drink Suggester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans">

    <div x-data="{
            tab: 'search',
            bookmarks: [],
            searchResults: [],
            probability: null,
            searched_ingredients: [],
            ingredientTags: [],
            best_guess: [],
            corrections: [],
            loading: false,
            loadingNext: false,
            exactMatch: false,
            nextSuggestions: [],
            expandedSuggestion: null,
            init() {
                const saved = localStorage.getItem('drinkBookmarks_v2');
                this.bookmarks = saved ? JSON.parse(saved) : [];
            },
            addIngredientTag(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const input = e.target;
                    const ingredient = input.value.trim();
                    if (ingredient && !this.ingredientTags.includes(ingredient.toLowerCase())) {
                        this.ingredientTags.push(ingredient.toLowerCase());
                    }
                    input.value = '';
                    // Automatically search after adding a tag
                    try {
                        this.searchDrinks();
                    } catch (err) {
                        console.error('Auto-search failed:', err);
                    }
                }
            },
            removeIngredientTag(index) {
                this.ingredientTags.splice(index, 1);
                // Clear autocorrect suggestions when no tags remain
                if (this.ingredientTags.length === 0) {
                    this.corrections = [];
                    this.best_guess = [];
                    this.searchResults = [];
                    this.probability = null;
                } else {
                    // Auto-run search after removing a tag
                    try {
                        this.searchDrinks();
                    } catch (err) {
                        console.error('Auto-search on remove failed:', err);
                    }
                }
            },
            async searchDrinks(e) {
                if (e && e.preventDefault) e.preventDefault();
                
                // If there's text in the input, convert it to a tag before searching
                try {
                    const inputEl = document.getElementById('ingredients');
                    const inputVal = inputEl ? inputEl.value.trim() : '';
                    if (inputVal) {
                        const lower = inputVal.toLowerCase();
                        if (!this.ingredientTags.includes(lower)) {
                            this.ingredientTags.push(lower);
                        }
                        if (inputEl) inputEl.value = '';
                    }
                } catch (err) {
                    console.warn('Error reading input field:', err);
                }

                if (!this.ingredientTags.length) {
                    alert('Please add at least one ingredient');
                    return;
                }
                
                this.loading = true;
                try {
                    const response = await fetch('/suggest', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            ingredients: this.ingredientTags, 
                            exact_match: this.exactMatch 
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to get suggestions');
                    }
                    
                    const data = await response.json();
                    console.log('suggest /response', data);
                    this.probability = data.probability;
                    this.searchResults = data.similar_drinks;
                    this.best_guess = data.best_guess || [];
                    this.corrections = data.corrections || [];
                    this.searched_ingredients = this.ingredientTags;
                    window.drinkResultsData = data.similar_drinks;
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error fetching suggestions');
                } finally {
                    this.loading = false;
                }
            },
            async suggestNextIngredient() {
                if (!this.ingredientTags.length) {
                    alert('Please add at least one ingredient first');
                    return;
                }
                this.loadingNext = true;
                this.nextSuggestions = [];
                this.expandedSuggestion = null;
                try {
                    const response = await fetch('/suggest_next', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ingredients: this.ingredientTags, top_n: 5 })
                    });
                    if (!response.ok) throw new Error('Failed to get next ingredient suggestions');
                    const data = await response.json();
                    this.nextSuggestions = data.suggestions || [];
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error fetching next ingredient suggestions');
                } finally {
                    this.loadingNext = false;
                }
            },
            toggleSuggestion(index) {
                this.expandedSuggestion = this.expandedSuggestion === index ? null : index;
            },
            toggleBookmark(drink) {
                if (!drink || !drink.name) return;
                const index = this.bookmarks.findIndex(b => b.name === drink.name);
                if (index > -1) {
                    this.bookmarks.splice(index, 1);
                } else {
                    this.bookmarks.push(drink);
                }
                localStorage.setItem('drinkBookmarks_v2', JSON.stringify(this.bookmarks));
            },
            isBookmarked(drinkName) {
                return this.bookmarks.some(b => b.name === drinkName);
            }
        }" x-init="init()" class="w-full max-w-2xl mx-auto py-8 px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-center mb-4 text-gray-800">Drink Suggester</h1>

            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <a href="#" @click.prevent="tab = 'search'"
                        :class="tab === 'search' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                        Suggest Drinks
                    </a>
                    <a href="#" @click.prevent="tab = 'bookmarks'"
                        :class="tab === 'bookmarks' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">
                        My Bookmarks
                        <span x-show="bookmarks.length > 0" x-text="bookmarks.length"
                            class="ml-2 inline-block py-0.5 px-2 rounded-full text-xs font-medium bg-blue-100 text-blue-600"></span>
                    </a>
                </nav>
            </div>

            <div x-show="tab === 'search'" x-cloak>
                <form @submit="searchDrinks" class="mb-6">
                    <label for="ingredients" class="block mb-2 font-medium text-gray-700">Ingredients (type and press
                        Enter or comma):</label>
                    <div class="relative">
                        <input type="text" id="ingredients" name="ingredients" @keydown="addIngredientTag"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
                            placeholder="e.g. vodka, lime juice">
                    </div>

                    <!-- Correction suggestions (autocorrect mapping) -->
                    <div x-show="corrections.length > 0" class="mt-2">
                        <p class="text-sm text-gray-600 mb-1">Did you mean:</p>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="(c, i) in corrections" :key="i">
                                <button type="button" @click="ingredientTags = best_guess; searchDrinks()"
                                    class="inline-flex items-center gap-2 px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                                    <span x-text="c.original"></span>
                                    <svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7" />
                                    </svg>
                                    <span x-text="c.corrected"></span>
                                </button>
                            </template>
                            <template x-if="corrections.length > 0">
                                <button type="button" @click="ingredientTags = best_guess; searchDrinks()"
                                    class="inline-flex items-center gap-2 px-3 py-1 bg-yellow-200 text-yellow-900 rounded-full text-sm font-semibold">
                                    Apply all corrections
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Ingredient Tags -->
                    <div x-show="ingredientTags.length > 0" class="mt-3 flex flex-wrap gap-2">
                        <template x-for="(tag, index) in ingredientTags" :key="index">
                            <span
                                class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">
                                <span x-text="tag"></span>
                                <button type="button" @click="removeIngredientTag(index)"
                                    class="text-blue-500 hover:text-blue-700 font-bold cursor-pointer">
                                    ×
                                </button>
                            </span>
                        </template>
                    </div>

                    <div class="mt-4 flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" x-model="exactMatch"
                                class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm font-medium text-gray-700">Exact Match Only (drinks with ONLY
                                these ingredients)</span>
                        </label>
                    </div>

                    <div class="mt-4 flex gap-3">
                        <button type="submit" :disabled="loading"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                            <span x-show="!loading">Suggest Drinks</span>
                            <span x-show="loading">Loading...</span>
                        </button>
                        <button type="button" @click.prevent="suggestNextIngredient()" :disabled="loadingNext"
                            class="flex-1 bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                            <span x-show="!loadingNext">✨ What to Add Next?</span>
                            <span x-show="loadingNext">Thinking...</span>
                        </button>
                    </div>
                </form>

                <!-- Next Ingredient Suggestions Panel -->
                <div x-show="nextSuggestions.length > 0" x-cloak class="mb-6">
                    <hr class="my-4 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <h5 class="text-lg font-bold text-gray-800">✨ Suggested Next Ingredients</h5>
                        <button type="button" @click="nextSuggestions = []; expandedSuggestion = null"
                            class="p-1 rounded-full text-gray-400 hover:text-gray-700 hover:bg-gray-100 transition-colors"
                            title="Close suggestions">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="space-y-2">
                        <template x-for="(suggestion, index) in nextSuggestions" :key="index">
                            <div class="rounded-lg border border-emerald-200 bg-emerald-50 overflow-hidden">
                                <!-- Suggestion header (always visible) -->
                                <button type="button" @click="toggleSuggestion(index)"
                                    class="w-full flex items-center justify-between px-4 py-3 text-left hover:bg-emerald-100 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <span class="font-semibold text-emerald-900 capitalize"
                                            x-text="suggestion.ingredient"></span>
                                        <span class="px-2 py-0.5 rounded-full text-xs font-bold" :class="{
                                                'bg-green-200 text-green-800': suggestion.score >= 0.7,
                                                'bg-yellow-200 text-yellow-800': suggestion.score >= 0.4 && suggestion.score < 0.7,
                                                'bg-red-200 text-red-800': suggestion.score < 0.4
                                              }" x-text="Math.round(suggestion.score * 100) + '% score'"></span>
                                        <span class="text-xs text-emerald-700"
                                            x-text="suggestion.matching_drinks.length + ' drink(s) matched'"></span>
                                    </div>
                                    <svg class="w-4 h-4 text-emerald-700 transition-transform"
                                        :class="expandedSuggestion === index ? 'rotate-180' : ''" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>

                                <!-- Expandable drink list -->
                                <div x-show="expandedSuggestion === index" x-cloak
                                    class="border-t border-emerald-200 divide-y divide-emerald-100">
                                    <template x-for="(drink, di) in suggestion.matching_drinks" :key="di">
                                        <div class="px-4 py-3 bg-white">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="font-semibold text-blue-700" x-text="drink.name"></span>
                                                <span
                                                    class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 text-xs font-semibold"
                                                    x-text="(drink.similarity * 100).toFixed(1) + '% match'"></span>
                                            </div>
                                            <!-- Ingredient matches -->
                                            <div x-show="drink.ingredient_matches && drink.ingredient_matches.length > 0"
                                                class="flex flex-wrap gap-2 mb-2">
                                                <template x-for="match in drink.ingredient_matches"
                                                    :key="match.user_ingredient + match.matched_ingredient">
                                                    <!-- Perfect match: green ✓ pill -->
                                                    <div x-show="match.score >= 100"
                                                        class="flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-green-100 border border-green-300 text-green-800 font-semibold">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3"
                                                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="3" d="M5 13l4 4L19 7" />
                                                        </svg>
                                                        <span x-text="match.matched_ingredient"></span>
                                                    </div>
                                                    <!-- Partial / autocorrected match -->
                                                    <div x-show="match.score < 100"
                                                        class="flex items-center text-xs p-1.5 rounded-md bg-gray-100">
                                                        <!-- Autocorrected badge -->
                                                        <span x-show="match.original_user_ingredient"
                                                            class="mr-1.5 px-1.5 py-0.5 rounded-full bg-orange-100 border border-orange-300 text-orange-700 font-semibold text-xs"
                                                            x-text="'✏ ' + match.original_user_ingredient"></span>
                                                        <span class="font-medium text-gray-800"
                                                            x-text="match.user_ingredient"></span>
                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                            class="h-3 w-3 mx-1.5 text-gray-400" fill="none"
                                                            viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                                        </svg>
                                                        <span class="text-gray-600"
                                                            x-text="match.matched_ingredient"></span>
                                                        <span class="ml-2 px-1.5 py-0.5 rounded-full text-xs font-bold"
                                                            :class="{
                                                                'bg-green-200 text-green-800': match.score > 85,
                                                                'bg-yellow-200 text-yellow-800': match.score > 70 && match.score <= 85,
                                                                'bg-red-200 text-red-800': match.score <= 70
                                                              }" x-text="Math.round(match.score) + '%'"></span>
                                                    </div>
                                                </template>
                                            </div>
                                            <p class="text-gray-500 text-xs">
                                                <span class="font-medium">Ingredients:</span>
                                                <span x-text="drink.ingredients.join(', ')"></span>
                                            </p>
                                        </div>
                                    </template>
                                    <div x-show="suggestion.matching_drinks.length === 0"
                                        class="px-4 py-3 text-sm text-gray-500 italic bg-white">
                                        No specific drinks matched yet — but adding this ingredient increases your
                                        cocktail score!
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div id="drink-results-container">
                    <div x-show="probability !== null">
                        <div x-show="!exactMatch" class="mb-6">
                            <hr class="my-6 border-t border-gray-200">
                            <div class="mb-6">
                                <h4 class="text-lg font-semibold mb-2 text-gray-800">
                                    Is this a cocktail?
                                    <span x-show="probability < 0.5"
                                        class="inline-block px-3 py-1 text-sm rounded-full bg-red-100 text-red-800 font-bold"
                                        x-text="Math.round(probability * 100) + '% Chance'"></span>
                                    <span x-show="probability >= 0.5"
                                        class="inline-block px-3 py-1 text-sm rounded-full bg-green-100 text-green-800 font-bold"
                                        x-text="Math.round(probability * 100) + '% Chance'"></span>
                                </h4>
                            </div>
                        </div>

                        <div x-show="exactMatch" class="mb-6">
                            <hr class="my-6 border-t border-gray-200">
                            <div class="mb-6">
                                <h5
                                    class="text-lg font-semibold text-gray-800 bg-blue-50 p-3 rounded-lg border border-blue-200">
                                    ✓ Exact Match Mode: Showing drinks with ONLY your ingredients
                                </h5>
                            </div>
                        </div>

                        <h5 class="text-xl font-bold mt-4 mb-3 text-gray-800">
                            <span x-show="!exactMatch">Suggested Drinks:</span>
                            <span x-show="exactMatch">Matching Drinks:</span>
                        </h5>
                        <div id="drink-list" class="space-y-4">
                            <template x-for="(drink, index) in searchResults" :key="index">
                                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex-1">
                                            <span class="font-bold text-lg text-blue-700" x-text="drink.name"></span>
                                            <span x-show="!exactMatch"
                                                class="block px-3 py-1 mt-1 w-fit rounded-full bg-blue-100 text-blue-800 text-xs font-semibold"
                                                x-text="(drink.similarity * 100).toFixed(1) + '% Match'"></span>
                                        </div>
                                        <button @click="toggleBookmark(drink)" title="Bookmark"
                                            class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                                            <svg x-show="!isBookmarked(drink.name)" class="w-5 h-5 text-gray-400"
                                                fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                            </svg>
                                            <svg x-show="isBookmarked(drink.name)" x-cloak
                                                class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                            </svg>
                                        </button>
                                    </div>

                                    <div x-show="!exactMatch && drink.ingredient_matches && drink.ingredient_matches.length > 0"
                                        class="mb-4">
                                        <div class="flex flex-wrap gap-2">
                                            <template x-for="match in drink.ingredient_matches"
                                                :key="match.user_ingredient + match.matched_ingredient">
                                                <!-- Perfect match: green ✓ pill -->
                                                <div x-show="match.score >= 100"
                                                    class="flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-green-100 border border-green-300 text-green-800 font-semibold">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none"
                                                        viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="3" d="M5 13l4 4L19 7" />
                                                    </svg>
                                                    <span x-text="match.matched_ingredient"></span>
                                                </div>
                                                <!-- Partial / autocorrected match -->
                                                <div x-show="match.score < 100"
                                                    class="flex items-center text-xs p-2 rounded-md bg-gray-200">
                                                    <!-- Autocorrected badge -->
                                                    <span x-show="match.original_user_ingredient"
                                                        class="mr-2 px-1.5 py-0.5 rounded-full bg-orange-100 border border-orange-300 text-orange-700 font-semibold text-xs"
                                                        x-text="'✏ ' + match.original_user_ingredient"></span>
                                                    <span class="font-medium text-gray-800"
                                                        x-text="match.user_ingredient"></span>
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                        class="h-4 w-4 mx-2 text-gray-500" fill="none"
                                                        viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                                    </svg>
                                                    <span class="text-gray-700"
                                                        x-text="match.matched_ingredient"></span>
                                                    <span class="ml-3 px-2 py-0.5 rounded-full text-xs font-bold"
                                                        :class="{
                                                        'bg-green-200 text-green-800': match.score > 85,
                                                        'bg-yellow-200 text-yellow-800': match.score > 70 && match.score <= 85,
                                                        'bg-red-200 text-red-800': match.score <= 70
                                                      }" x-text="Math.round(match.score) + '%'">
                                                    </span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>

                                    <p class="text-gray-600 text-sm"><span class="font-semibold">Ingredients:</span>
                                        <span x-text="drink.ingredients.join(', ')"></span>
                                    </p>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="tab === 'bookmarks'" x-cloak>
                <h5 class="text-xl font-bold mb-3 text-gray-800">Bookmarked Drinks</h5>
                <div x-show="bookmarks.length === 0" class="text-center py-8 px-4 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">You haven't bookmarked any drinks yet.</p>
                </div>
                <div class="space-y-4">
                    <template x-for="drink in bookmarks" :key="drink.name">
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <span class="font-bold text-lg text-blue-700" x-text="drink.name"></span>
                                </div>
                                <button @click="toggleBookmark(drink)" title="Remove Bookmark"
                                    class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                                    <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 24 24"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                    </svg>
                                </button>
                            </div>
                            <p class="text-gray-600 mb-4 text-sm">
                                <span class="font-semibold">Ingredients:</span>
                                <span
                                    x-text="Array.isArray(drink.ingredients) ? drink.ingredients.join(', ') : ''"></span>
                            </p>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</body>

</html>